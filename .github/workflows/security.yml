name: Comprehensive Security Analysis

on:
  # Run security analysis on all pushes and pull requests
  push:
    branches: [ main, develop, 'feature/*', 'automatic_static' ]
  pull_request:
    branches: [ main, develop ]
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run weekly security scans
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

jobs:
  static-analysis:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Bandit Static Security Analysis
      id: bandit
      run: |
        echo "üîç Running Bandit static security analysis..."
        
        # Run bandit and capture results
        if python -m bandit -r . -f json --confidence-level low --severity-level low --exclude tests,__pycache__,.git,venv,env,frontend/node_modules -o bandit_report.json; then
          echo "status=passed" >> $GITHUB_OUTPUT
          echo "‚úÖ Bandit analysis passed - No security issues found"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Bandit found potential security issues"
          
          # Show summary of issues (first 10 lines)
          echo "üìã Bandit Issues Summary:"
          python -m bandit -r . -f txt --confidence-level medium --severity-level medium --exclude tests,__pycache__,.git,venv,env,frontend/node_modules | head -20 || true
        fi

    - name: Run pip-audit Dependency Analysis
      id: pip-audit
      run: |
        echo "üîç Running pip-audit dependency vulnerability analysis..."
        
        # Run pip-audit and capture results (handle module name variation)
        if python -m pip_audit --format=json --desc --output=pip_audit_report.json 2>/dev/null || python -c "import pip_audit; pip_audit.main()" --format=json --desc --output=pip_audit_report.json; then
          echo "status=passed" >> $GITHUB_OUTPUT
          echo "‚úÖ pip-audit analysis passed - No known vulnerabilities found"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è pip-audit found known vulnerabilities"
          
          # Show summary of vulnerabilities (first 20 lines)
          echo "üìã Dependency Vulnerabilities Summary:"
          python -m pip_audit --desc 2>/dev/null | head -20 || echo "Vulnerability details in report file"
        fi

    - name: Run Comprehensive Security Analysis
      run: |
        echo "üöÄ Running comprehensive security analysis script..."
        python scripts/static_analysis.py --ci --save-reports

    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-analysis-reports
        path: |
          bandit_report.json
          bandit_report.txt
          pip_audit_report.json
          pip_audit_report.txt
          security_analysis_report_*.json
        retention-days: 30

    - name: Security Analysis Summary
      if: always()
      run: |
        echo "## üõ°Ô∏è Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Bandit results
        if [ "${{ steps.bandit.outputs.status }}" = "passed" ]; then
          echo "‚úÖ **Static Analysis (Bandit)**: PASSED - No security issues detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **Static Analysis (Bandit)**: ATTENTION NEEDED - Potential security issues found" >> $GITHUB_STEP_SUMMARY
        fi
        
        # pip-audit results
        if [ "${{ steps.pip-audit.outputs.status }}" = "passed" ]; then
          echo "‚úÖ **Dependency Analysis (pip-audit)**: PASSED - No known vulnerabilities" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **Dependency Analysis (pip-audit)**: ATTENTION NEEDED - Known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìä **Reports**: Check the 'security-analysis-reports' artifact for detailed findings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üí° **Next Steps**: Review any issues found and update dependencies as needed" >> $GITHUB_STEP_SUMMARY

    - name: Security Analysis Results
      if: always()
      run: |
        echo "üìä Security Analysis Complete"
        echo "Bandit Status: ${{ steps.bandit.outputs.status }}"
        echo "pip-audit Status: ${{ steps.pip-audit.outputs.status }}"
        
        # Note: We don't fail the build for security findings as they need review
        # This allows the analysis to complete and provide reports for review
        if [ "${{ steps.bandit.outputs.status }}" = "failed" ] || [ "${{ steps.pip-audit.outputs.status }}" = "failed" ]; then
          echo "‚ö†Ô∏è Security findings detected - please review the reports"
          echo "Reports are available in the artifacts section"
        else
          echo "‚úÖ No critical security issues detected"
        fi

  docker-security:
    name: Docker Security Analysis  
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'  # Skip Docker scan on weekly runs
    continue-on-error: true  # Don't fail the entire workflow if Docker analysis fails
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Images for Security Scanning
      run: |
        cd microservices
        echo "üèóÔ∏è Building Docker images for security analysis..."
        
        # Build auth service image for scanning (build one as example)
        docker build -t auth-service:security-scan ./auth-service || {
          echo "‚ö†Ô∏è Docker build failed - this is expected if there are build dependencies"
          echo "Skipping Docker security scan for this run"
          exit 0
        }

    - name: Run Trivy Security Scanner
      uses: aquasecurity/trivy-action@master
      continue-on-error: true
      with:
        image-ref: 'auth-service:security-scan'
        format: 'sarif'
        output: 'auth-service-trivy.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true
      if: always()
      with:
        sarif_file: 'auth-service-trivy.sarif'

    - name: Docker Image Vulnerability Summary
      run: |
        echo "üê≥ Docker security analysis summary..."
        
        # Check if auth-service image was built successfully
        if docker images | grep -q "auth-service.*security-scan"; then
          echo "‚úÖ Docker image built successfully"
          echo "üîç Running basic vulnerability scan..."
          
          # Install trivy if available
          if command -v trivy &> /dev/null; then
            trivy image --severity HIGH,CRITICAL --no-progress auth-service:security-scan || true
          else
            echo "‚ÑπÔ∏è Trivy scanning completed via GitHub Action above"
          fi
        else
          echo "‚ö†Ô∏è Docker image build was skipped - this is normal for dependency-based builds"
          echo "üí° In production environments, ensure Docker images are scanned regularly"
        fi
        
        echo ""
        echo "üìã Docker Security Best Practices:"
        echo "   ‚Ä¢ Keep base images updated to latest secure versions"
        echo "   ‚Ä¢ Regularly scan images for vulnerabilities"
        echo "   ‚Ä¢ Use minimal base images (e.g., alpine) when possible"
        echo "   ‚Ä¢ Implement image signing and verification in production"
        echo "   ‚Ä¢ Use multi-stage builds to reduce attack surface"