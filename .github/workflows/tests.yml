name: Run Tests

on:
  # Run full CI for pull requests targeting any branch
  pull_request:
    branches: [ '*' ]

  # For direct pushes, only run the full test suite on the main branch
  # (feature branches will be covered by the pull_request workflow)
  push:
    branches:
      - main

jobs:
  pytest-tests:
    name: Pytest Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov requests urllib3
    - name: Build and start microservices (with GAME_HISTORY_KEY)
      working-directory: microservices
      run: |
        # Verify required files exist for Docker build
        echo "Verifying Docker build context..."
        ls -la auth-service/requirements.txt || (echo "ERROR: auth-service/requirements.txt not found" && exit 1)
        ls -la utils/service_auth.py || (echo "ERROR: utils/service_auth.py not found" && exit 1)
        ls -la card-service/requirements.txt || (echo "ERROR: card-service/requirements.txt not found" && exit 1)
        ls -la game-service/requirements.txt || (echo "ERROR: game-service/requirements.txt not found" && exit 1)
        echo "All required files found. Building services..."
        chmod +x build-and-start.sh
        ./build-and-start.sh

    - name: Wait for services to be healthy
      working-directory: microservices
      run: |
        chmod +x wait-for-services.sh
        ./wait-for-services.sh

    - name: Verify services are running
      working-directory: microservices
      run: |
        docker ps
        echo "=== Service Status ==="
        docker compose ps
        echo ""
        echo "=== Testing Auth Service through API Gateway ==="
        curl -f -k https://localhost:8443/api/auth/health
        echo ""
        echo "=== Testing Card Service through API Gateway ==="
        curl -f -k https://localhost:8443/api/cards/health

    - name: Run pytest tests for microservices
      env:
        BASE_URL: https://localhost:8443
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "Running pytest tests..."
        pytest tests/test_auth_service.py -v --tb=short
        pytest tests/test_card_service.py -v --tb=short
        pytest tests/test_game_service.py -v --tb=short
        pytest tests/test_leaderboard_service.py -v --tb=short
        pytest tests/test_zero_trust.py -v --tb=short

    - name: Show service logs on failure
      if: failure()
      working-directory: microservices
      run: |
        echo "=== Docker Compose Services ==="
        docker compose ps -a
        echo ""
        echo "=== PostgreSQL Logs ==="
        docker compose logs postgresql || true
        echo ""
        echo "=== Auth Service Logs ==="
        docker compose logs auth-service || true
        echo ""
        echo "=== Card Service Logs ==="
        docker compose logs card-service || true
        echo ""
        echo "=== Game Service Logs ==="
        docker compose logs game-service || true
        echo ""
        echo "=== Leaderboard Service Logs ==="
        docker compose logs leaderboard-service || true
        echo ""
        echo "=== Logs Service Logs ==="
        docker compose logs logs-service || true
        echo ""
        echo "=== Nginx/API Gateway Logs ==="
        docker compose logs api-gateway || true

    - name: Cleanup
      if: always()
      working-directory: microservices
      run: |
        docker compose down -v

  postman-tests:
    name: Postman/Newman Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Node.js for Newman
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install Newman (Postman CLI)
      run: |
        npm install -g newman
        npm install -g newman-reporter-htmlextra
    - name: Build and start microservices (with GAME_HISTORY_KEY)
      working-directory: microservices
      run: |
        # Verify required files exist for Docker build
        echo "Verifying Docker build context..."
        ls -la auth-service/requirements.txt || (echo "ERROR: auth-service/requirements.txt not found" && exit 1)
        ls -la utils/service_auth.py || (echo "ERROR: utils/service_auth.py not found" && exit 1)
        echo "All required files found. Building services..."
        chmod +x build-and-start.sh
        ./build-and-start.sh

    - name: Wait for services to be healthy
      working-directory: microservices
      run: |
        chmod +x wait-for-services.sh
        ./wait-for-services.sh

    - name: Verify services are running
      working-directory: microservices
      run: |
        docker ps
        echo "=== Service Status ==="
        docker compose ps
        echo ""
        echo "=== Testing Auth Service through API Gateway ==="
        curl -f -k https://localhost:8443/api/auth/health
        echo ""
        echo "=== Testing Card Service through API Gateway ==="
        curl -f -k https://localhost:8443/api/cards/health

    - name: Run Postman tests with Newman
      run: |
        echo "Running Postman/Newman tests..."
        newman run tests/microservices_postman_collection.json \
          --environment tests/postman_environment.json \
          --reporters cli,htmlextra \
          --reporter-htmlextra-export newman-report.html \
          --insecure \
          --delay-request 100 \
          --color on

    - name: Upload Newman report
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: newman-report
        path: newman-report.html

    - name: Show service logs on failure
      if: failure()
      working-directory: microservices
      run: |
        echo "=== Docker Compose Services ==="
        docker compose ps -a
        echo ""
        echo "=== PostgreSQL Logs ==="
        docker compose logs postgresql || true
        echo ""
        echo "=== Auth Service Logs ==="
        docker compose logs auth-service || true
        echo ""
        echo "=== Card Service Logs ==="
        docker compose logs card-service || true
        echo ""
        echo "=== Game Service Logs ==="
        docker compose logs game-service || true
        echo ""
        echo "=== Leaderboard Service Logs ==="
        docker compose logs leaderboard-service || true
        echo ""
        echo "=== Logs Service Logs ==="
        docker compose logs logs-service || true
        echo ""
        echo "=== Nginx/API Gateway Logs ==="
        docker compose logs api-gateway || true

    - name: Cleanup
      if: always()
      working-directory: microservices
      run: |
        docker compose down -v

  locust-tests:
    name: Locust Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Build and start microservices (with GAME_HISTORY_KEY)
      working-directory: microservices
      run: |
        # Verify required files exist for Docker build
        echo "Verifying Docker build context..."
        ls -la auth-service/requirements.txt || (echo "ERROR: auth-service/requirements.txt not found" && exit 1)
        ls -la utils/service_auth.py || (echo "ERROR: utils/service_auth.py not found" && exit 1)
        echo "All required files found. Building services..."
        chmod +x build-and-start.sh
        ./build-and-start.sh

    - name: Wait for services to be healthy
      working-directory: microservices
      run: |
        chmod +x wait-for-services.sh
        ./wait-for-services.sh

    - name: Verify services are running
      working-directory: microservices
      run: |
        docker ps
        echo "=== Service Status ==="
        docker compose ps
        echo ""
        echo "=== Testing Auth Service through API Gateway ==="
        curl -f -k https://localhost:8443/api/auth/health
        echo ""
        echo "=== Testing Card Service through API Gateway ==="
        curl -f -k https://localhost:8443/api/cards/health

    - name: Run Locust performance tests (headless)
      run: |
        echo "Running Locust performance tests..."
        cd tests
        locust -f locustfile.py \
          --headless \
          --users 10 \
          --spawn-rate 2 \
          --run-time 60s \
          --host https://localhost:8443 \
          --html locust-report.html \
          --csv locust-results

    - name: Upload Locust reports
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: locust-reports
        path: |
          tests/locust-report.html
          tests/locust-results*.csv

    - name: Show service logs on failure
      if: failure()
      working-directory: microservices
      run: |
        echo "=== Docker Compose Services ==="
        docker compose ps -a
        echo ""
        echo "=== PostgreSQL Logs ==="
        docker compose logs postgresql || true
        echo ""
        echo "=== Auth Service Logs ==="
        docker compose logs auth-service || true
        echo ""
        echo "=== Card Service Logs ==="
        docker compose logs card-service || true
        echo ""
        echo "=== Game Service Logs ==="
        docker compose logs game-service || true
        echo ""
        echo "=== Leaderboard Service Logs ==="
        docker compose logs leaderboard-service || true
        echo ""
        echo "=== Logs Service Logs ==="
        docker compose logs logs-service || true
        echo ""
        echo "=== Nginx/API Gateway Logs ==="
        docker compose logs api-gateway || true

    - name: Cleanup
      if: always()
      working-directory: microservices
      run: |
        docker compose down -v

