# Zero-Trust Networking Implementation

## Overview

This document describes the zero-trust networking implementation for the Battle Cards microservices architecture. Zero-trust principles ensure that no service is trusted by default, and all inter-service communication requires authentication and authorization.

## Implementation Summary

### ✅ Completed Features

1. **Service-to-Service Authentication**
   - Implemented API key-based authentication for inter-service communication
   - Each service has a unique API key stored in environment variables
   - Service API keys are automatically generated by `build-and-start.sh`
   - Keys are stored in `.env` file (gitignored for security)

2. **Removed Port Exposure**
   - Internal service ports (5001, 5002, 5003, 5004, 5006) are no longer exposed to the host
   - Services are only accessible through the API gateway (ports 8080/8443)
   - Database port (5432) remains exposed for development/debugging (can be removed in production)

3. **Service Authentication Middleware**
   - Created `service_auth.py` utility module for service-to-service authentication
   - Services validate `X-Service-API-Key` header when present
   - Supports both user requests (through API gateway) and service-to-service calls

4. **Updated Service-to-Service Calls**
   - Game Service → Card Service: Includes service API key
   - Card Service → Auth Service: Includes service API key
   - All service-to-service HTTP requests now include `X-Service-API-Key` header

5. **Network Policies**
   - Services communicate only through Docker internal network (`battlecards-network`)
   - No direct external access to internal services
   - API gateway is the single entry point

6. **Separate Service Credentials**
   - Each service has its own API key:
     - `AUTH_SERVICE_API_KEY`
     - `CARD_SERVICE_API_KEY`
     - `GAME_SERVICE_API_KEY`
     - `LEADERBOARD_SERVICE_API_KEY`
     - `LOGS_SERVICE_API_KEY`
   - Keys are generated using cryptographically secure random generation

7. **Zero-Trust Tests**
   - Created `test_zero_trust.py` to verify implementation
   - Tests verify that internal ports are not exposed
   - Tests verify service authentication is in place
   - Tests verify API gateway is the only entry point

## Architecture Changes

### Before (Non-Zero-Trust)
```
External Network
    ↓
[Port 5001] Auth Service
[Port 5002] Card Service
[Port 5003] Game Service
[Port 5004] Leaderboard Service
[Port 5006] Logs Service
    ↓
Internal Docker Network
```

### After (Zero-Trust)
```
External Network
    ↓
[Port 8443] API Gateway (HTTPS)
    ↓
Internal Docker Network (battlecards-network)
    ↓
Auth Service (no external port)
Card Service (no external port)
Game Service (no external port)
Leaderboard Service (no external port)
Logs Service (no external port)
```

## Service API Keys

Service API keys are automatically generated when running `build-and-start.sh`. The keys are:

- Generated using cryptographically secure random generation (32-byte urlsafe base64)
- Stored in `.env` file (gitignored)
- Shared across all services via environment variables
- Used for service-to-service authentication

## Service-to-Service Communication

### Example: Game Service calling Card Service

```python
from service_auth import ServiceAuth

headers = {
    "Authorization": f"Bearer {user_token}",
    "X-Service-API-Key": ServiceAuth.get_service_key("game-service")
}
response = requests.post(
    f"{CARD_SERVICE_URL}/api/cards/random-deck",
    headers=headers,
    json={"size": 22}
)
```

### Example: Card Service validating service call

```python
from service_auth import ServiceAuth

# In endpoint handler
service_key = request.headers.get('X-Service-API-Key', '')
if service_key:
    if not ServiceAuth.validate_service_key(service_key):
        return jsonify({"error": "Invalid service credentials"}), 403
```

## Configuration

### Docker Compose

Service API keys are configured in `docker-compose.yml`:

```yaml
environment:
  - SERVICE_NAME=game-service
  - AUTH_SERVICE_API_KEY=${AUTH_SERVICE_API_KEY}
  - CARD_SERVICE_API_KEY=${CARD_SERVICE_API_KEY}
  - GAME_SERVICE_API_KEY=${GAME_SERVICE_API_KEY}
  # ... other service keys
```

### Build Script

The `build-and-start.sh` script automatically:
1. Generates service API keys if not present
2. Saves keys to `.env` file
3. Exports keys for docker-compose

## Testing

Run zero-trust tests:

```bash
pytest tests/test_zero_trust.py -v
```

Or run all tests including zero-trust:

```bash
pytest tests/ -v
```

## Security Benefits

1. **No Trust by Default**: Services must authenticate even within the internal network
2. **Reduced Attack Surface**: Internal services are not exposed to external network
3. **Principle of Least Privilege**: Services only have access to what they need
4. **Defense in Depth**: Multiple layers of security (network isolation + authentication)
5. **Audit Trail**: Service-to-service calls can be logged and audited

## Migration Notes

### Breaking Changes

- Internal service ports are no longer accessible from host machine
- All access must go through API gateway
- Service-to-service calls must include API keys

### Backward Compatibility

- User requests through API gateway continue to work (no service key required)
- Existing functionality is preserved
- Only internal service-to-service communication requires changes

## Future Enhancements

1. **mTLS (Mutual TLS)**: Upgrade from API keys to mTLS for stronger authentication
2. **Service Mesh**: Implement Istio or Linkerd for advanced traffic management
3. **Network Policies**: Add Kubernetes network policies for fine-grained control
4. **Key Rotation**: Implement automatic key rotation mechanism
5. **Service Discovery**: Add service discovery with authentication

## Troubleshooting

### Services can't communicate

1. Check that service API keys are set in `.env` file
2. Verify keys are exported in docker-compose environment
3. Check service logs for authentication errors

### Port access errors

- Internal service ports (5001-5006) should NOT be accessible from host
- Only API gateway ports (8080, 8443) should be accessible
- If you need to access a service directly, use `docker exec` to enter the container

### Service authentication failures

1. Verify `X-Service-API-Key` header is included in service-to-service calls
2. Check that service keys match between calling and receiving services
3. Verify `SERVICE_NAME` environment variable is set correctly

## References

- [Zero Trust Architecture](https://www.nist.gov/publications/zero-trust-architecture)
- [Service-to-Service Authentication Best Practices](https://kubernetes.io/docs/concepts/security/network-policies/)
