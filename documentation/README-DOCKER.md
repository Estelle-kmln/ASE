# Battle Card Game - Docker Setup

This project includes Docker configurations for running the battle card game with a PostgreSQL database.

## Architecture

The Battle Cards application uses a microservices architecture with the following containers:

- **Nginx Gateway**: Reverse proxy with HTTPS/TLS (ports 8443, 8080)
- **Auth Service**: User authentication, sessions, token refresh (port 5001)
- **Card Service**: Card database and deck generation (port 5002)
- **Game Service**: Game logic, invitations, deck selection (port 5003)
- **Leaderboard Service**: Rankings and statistics (port 5004)
- **Logs Service**: User action logging and audit trails (port 5005)
- **PostgreSQL Container**: Data persistence for all services (port 5432)
- **Docker Compose**: Orchestrates all containers with proper networking

## Quick Start

### Prerequisites
- Docker and Docker Compose installed
- Git (to clone the repository)

### Running the Application

1. **Build and start all services:**
   ```bash
   cd microservices
   docker compose up -d --build
   ```
   This automatically generates SSL certificates and starts all services.

2. **Optional - Production setup with security enhancements:**
   
   **Linux/Mac/WSL:**
   ```bash
   ./build-and-start.sh
   ```
   
   **Windows:**
   ```powershell
   .\build-and-start.ps1
   ```
   
   These scripts automatically generate the `GAME_HISTORY_KEY` and service API keys for enhanced security.

3. **Access the application:**
   - Frontend: `https://localhost:8443` (HTTPS with self-signed certificate)
   - API Gateway: `https://localhost:8443/api`
   - HTTP requests to port 8080 automatically redirect to HTTPS

4. **Verify all services are running:**
   ```bash
   docker-compose ps
   # All services should show "Up" and "healthy"
   
   # Test gateway health
   curl -k https://localhost:8443/health
   ```

### Database Access

- **PostgreSQL Connection**: `postgresql://battlecards_user:battlecards_password@localhost:5432/battlecards_db`
- **Database Name**: `battlecards_db`
- **Tables**: `users`, `cards`, `games`, `game_history`, `user_sessions`, `refresh_tokens`, `user_logs`

### Useful Commands

```bash
# View logs for all services
docker-compose logs -f

# View logs for specific service
docker-compose logs -f auth-service
docker-compose logs -f game-service
docker-compose logs -f api-gateway
docker-compose logs -f postgresql

# Stop all services
docker-compose down

# Stop and remove volumes (deletes all data)
docker-compose down -v

# Rebuild specific service
docker-compose up -d --build auth-service

# Rebuild all containers from scratch
docker-compose build --no-cache
docker-compose up -d

# Access PostgreSQL shell
docker-compose exec postgresql psql -U battlecards_user -d battlecards_db

# Access service container bash
docker-compose exec auth-service bash
docker-compose exec game-service bash

# Check service health
curl -k https://localhost:8443/api/auth/health
curl -k https://localhost:8443/api/cards/health
curl -k https://localhost:8443/api/games/health
curl -k https://localhost:8443/api/leaderboard/health
curl -k https://localhost:8443/api/logs/health
```

## Card Data

The PostgreSQL container is pre-populated with 39 battle cards:
- **Rock Cards**: 13 cards with power values 1-13
- **Paper Cards**: 13 cards with power values 1-13
- **Scissors Cards**: 13 cards with power values 1-13

Players build 22-card decks from these cards for battles.

## Development

### Local Development Setup
```bash
# Install Python dependencies for testing
pip install -r requirements.txt

# Start only PostgreSQL for local development
cd microservices
docker-compose up -d postgresql

# Run individual service locally (example: auth service)
cd microservices/auth-service
export DATABASE_URL="postgresql://battlecards_user:battlecards_password@localhost:5432/battlecards_db"
export JWT_SECRET_KEY="your-dev-secret-key"
flask run --port 5001
```

### Environment Variables

Required environment variables (automatically configured in docker-compose.yml):

- `DATABASE_URL`: PostgreSQL connection string
- `JWT_SECRET_KEY`: Secret key for JWT token signing
- `GAME_HISTORY_KEY`: 32-byte base64 key for game history encryption (auto-generated)
- `FLASK_ENV`: Flask environment (development/production)
- `POSTGRES_USER`: PostgreSQL username (battlecards_user)
- `POSTGRES_PASSWORD`: PostgreSQL password
- `POSTGRES_DB`: Database name (battlecards_db)

**Security Note**: The `GAME_HISTORY_KEY` is automatically generated by `build-and-start.sh` and stored in `.env` (gitignored). Never commit secrets to version control.

## Troubleshooting

### Container Issues
- Check container status: `docker-compose ps`
- View container logs: `docker-compose logs [service-name]`
- Restart services: `docker-compose restart`

### Database Connection Issues
- Ensure PostgreSQL container is healthy: `docker-compose ps`
- Check network connectivity: `docker-compose exec game-app ping postgresql`
- Verify PostgreSQL is accepting connections: `docker-compose exec postgresql pg_isready -U gameuser -d battlecards`

### Data Persistence
- PostgreSQL data persists in Docker volume `postgresql_data`
- To reset database: `docker-compose down -v` (removes all data)